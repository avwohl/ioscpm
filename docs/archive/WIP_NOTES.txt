Work In Progress Notes - Z80CPM
================================

SESSION: Dec 17, 2025 (afternoon)
---------------------------------

CLEANUP AND SLICE COUNT FEATURE:
1. Removed non-working ROMs - kept only emu_avw.rom
   - Deleted: SBC_simh_std.rom, emu_romwbw.rom, RCZ80_std.rom, emu_rcz80.rom

2. Cleaned up disks - kept only combo and rebuilt infocom
   - Deleted: hd1k_cpm22.img, hd1k_zsdos.img, hd1k_zpm3.img, hd1k_utils.img
   - Copied rebuilt hd1k_infocom.img from romwbw_emu (has proper boot sector)

3. Added configurable slice count per disk (1-8, default 4)
   - UI: Stepper in Settings next to each disk picker
   - Persists in UserDefaults
   - Calls setDiskSliceCount() after loading each disk
   - Lower slice counts use less HBIOS heap memory (helps with Zork!)

4. VT100 terminal support confirmed - should work with Zork blanking screen

Files changed:
- hbios_core.h, hbios_core.cc: Added setDiskSliceCount()
- RomWBWEmulator.h, RomWBWEmulator.mm: Bridge for slice count
- EmulatorViewModel.swift: diskSliceCounts array, restoration, loading
- ContentView.swift: UI for slice count stepper
- disks.xml, release_assets/disks.xml: Only combo and infocom

SESSION: Dec 17, 2025 (investigation - CBIOS slice behavior)
------------------------------------------------------------

FINDING: CBIOS IGNORES HCB DRIVE MAP
------------------------------------
Root cause of "8 slices showing despite max_slices=4" identified:

1. The HCB drive map (CB_DRVMAP at HCB+0x20) and CB_DEVCNT ARE correctly
   updated with the limited slice count (verified via debug output).

2. However, CBIOS (loaded from the CP/M boot sector on disk) completely
   ignores the HCB drive map. It has its own hardcoded slice configuration
   that was set at ROM/disk image build time.

3. EXTSLICE and DIOCAP are NOT called by CBIOS during drive configuration.
   These functions would be our hooks to limit slices at runtime, but CBIOS
   doesn't use them.

Evidence:
- HCB drive map correctly shows only 6 drives (A-F) with max_slices=4
- CB_DEVCNT = 0x06 (6 drives)
- But CBIOS "Configuring Drives..." output shows A-J (10 drives, 8 HD slices)
- No EXTSLICE or DIOCAP calls logged during boot

FIX APPLIED - ROM WRITES:
-------------------------
Fixed populateDiskUnitTable() to write directly to ROM using get_rom()
instead of write_bank(0x00, ...) which silently ignores ROM writes.
This ensures the boot loader can read the correct drive map.

However, this doesn't fix the CBIOS behavior - the CBIOS binary on the disk
has hardcoded slice counts. Options to truly limit slices:
1. Use a ROM/disk with configurable slice count (rebuild CP/M disk)
2. Make disk I/O to slices >= max_slices fail (causes errors on G-J access)
3. Accept that CBIOS shows all slices but only configure for limited I/O

Files changed:
- hbios_dispatch.cc: populateDiskUnitTable() - use rom[] directly instead of
  write_bank(0x00, ...) which was being ignored

SESSION: Dec 17, 2025 (continued - slice count fix)
---------------------------------------------------

SLICE COUNT FIX - EXTSLICE HANDLER:
Root cause identified: The configurable slice count (setDiskSliceCount) was working
correctly to set max_slices and populate the HCB drive map with limited slices.
However, CBIOS doesn't use the drive map for slice enumeration - it queries HBIOS
directly via EXTSLICE function to determine available slices based on disk size.

Fix: Modified EXTSLICE handler in hbios_dispatch.cc to check max_slices:
- When slice >= max_slices, return HBR_FAILED (0xFF) and media_id=0 (MID_NONE)
- This tells CBIOS to stop enumerating slices at the configured limit
- Added debug logging to show when slices are rejected

Files changed:
- hbios_dispatch.cc: EXTSLICE handler (case HBF_EXTSLICE around line 2016)

This should finally make the slice count stepper work properly and reduce
HBIOS heap usage when fewer slices are configured.

SESSION: Dec 17, 2025 (afternoon - earlier)
-------------------------------------------

DISK MOUNTING BUGS FIXED:
1. closeDisk() was not resetting partition detection fields (partition_probed,
   partition_base_lba, slice_size, is_hd1k, current_lba). This caused wrong
   disk format detection when loading new disks.
   - Fixed in: hbios_dispatch.cc:closeDisk()

2. populateDiskUnitTable() was never called. The command line emulator calls
   this to populate the HCB disk unit table so romldr can enumerate disks.
   Without this, the boot loader couldn't find attached disks.
   - Fixed in: hbios_dispatch.cc:initMemoryDisks() - now calls populateDiskUnitTable()
     at the end, so all emulators get it automatically

VERIFIED:
- ROM files are byte-for-byte identical between iOS app and command line
- GitHub release disk (hd1k_combo.img) boots correctly in command line emulator
- hbios_dispatch.cc and hbios_dispatch.h are identical between both versions (symlinked)

REMAINING HEAP ISSUE:
- Both CLI and iOS configure 8 HD slices (C-J) for hd1k_combo - this is correct
- CLI: 1859 disk buffer bytes free, boots successfully
- iOS: 170 disk buffer bytes free, heap exhausted at drive H, PANIC
- Root cause: iOS heap is being consumed faster than CLI
- Added SYSALLOC logging to track heap allocations
- Need to investigate why iOS uses ~1700 more heap bytes than CLI

INFOCOM/ZORK CRASH:
- hd1k_infocom.img crashes in CLI too (not iOS-specific)
- User debugging in romwbw_emu project first (easier to debug CLI)
- Will return to test iOS after CLI works

SESSION: Dec 17, 2024
---------------------

COMPLETED THIS SESSION:
- Fixed disk count persistence bug: added closeAllDisks() to clear old disks before loading new config
  - Files changed: hbios_core.cc, hbios_core.h, RomWBWEmulator.mm, RomWBWEmulator.h, EmulatorViewModel.swift
- Fixed auto-download: disks marked "(download)" now download when Play is pressed
- Fixed silent error handling: added popup alerts for catalog/disk errors

KNOWN ISSUE - ZORK1 PANIC:
- Running ZORK1 on infocom disk causes PANIC: @833C[32BB:0003:85BA:FD3F:D7A5]
- Boot shows "Insufficient HBIOS Heap Memory" for drives H, I, J
- Heap: starts at 0x0200, ends at 0x8000 (32KB available)
- Heap appears to run out during drive configuration (hd1k has 8 slices = A-H)
- Investigation needed: why is heap exhausted? Are allocations too large?
- Debug: enable debugMode in app to see SYSALLOC log messages

PREVIOUS NOTES:
---------------
- App renamed from RomWBW to Z80CPM
- Version 1.1.0 released with R8/W8 host file transfer utilities
- GitHub disks.xml catalog available

REMAINING TASKS:
- Fix Zork/Infocom issue for App Store release
- Mac App Store screenshots if needed

FUTURE REFACTORING:
- Unify disk handling: CLI (romwbw_emu.cc) has parallel disk I/O implementation
  instead of using shared hbios_dispatch.cc. Only difference is storage backend
  (FILE* vs uint8_t* buffer). Could refactor CLI to use HBIOSDispatch class.
- Slice count limitation: CBIOS ignores HCB drive map, has hardcoded slice counts.
  Would need to rebuild CP/M disk image with different config, or make I/O fail
  for slices >= max_slices.
