Work In Progress Notes - Z80CPM
================================

SESSION: Dec 17, 2025 (afternoon)
---------------------------------

CLEANUP AND SLICE COUNT FEATURE:
1. Removed non-working ROMs - kept only emu_avw.rom
   - Deleted: SBC_simh_std.rom, emu_romwbw.rom, RCZ80_std.rom, emu_rcz80.rom

2. Cleaned up disks - kept only combo and rebuilt infocom
   - Deleted: hd1k_cpm22.img, hd1k_zsdos.img, hd1k_zpm3.img, hd1k_utils.img
   - Copied rebuilt hd1k_infocom.img from romwbw_emu (has proper boot sector)

3. Added configurable slice count per disk (1-8, default 4)
   - UI: Stepper in Settings next to each disk picker
   - Persists in UserDefaults
   - Calls setDiskSliceCount() after loading each disk
   - Lower slice counts use less HBIOS heap memory (helps with Zork!)

4. VT100 terminal support confirmed - should work with Zork blanking screen

Files changed:
- hbios_core.h, hbios_core.cc: Added setDiskSliceCount()
- RomWBWEmulator.h, RomWBWEmulator.mm: Bridge for slice count
- EmulatorViewModel.swift: diskSliceCounts array, restoration, loading
- ContentView.swift: UI for slice count stepper
- disks.xml, release_assets/disks.xml: Only combo and infocom

SESSION: Dec 17, 2025 (continued)
---------------------------------

DISK MOUNTING BUGS FIXED:
1. closeDisk() was not resetting partition detection fields (partition_probed,
   partition_base_lba, slice_size, is_hd1k, current_lba). This caused wrong
   disk format detection when loading new disks.
   - Fixed in: hbios_dispatch.cc:closeDisk()

2. populateDiskUnitTable() was never called. The command line emulator calls
   this to populate the HCB disk unit table so romldr can enumerate disks.
   Without this, the boot loader couldn't find attached disks.
   - Fixed in: hbios_dispatch.cc:initMemoryDisks() - now calls populateDiskUnitTable()
     at the end, so all emulators get it automatically

VERIFIED:
- ROM files are byte-for-byte identical between iOS app and command line
- GitHub release disk (hd1k_combo.img) boots correctly in command line emulator
- hbios_dispatch.cc and hbios_dispatch.h are identical between both versions (symlinked)

REMAINING HEAP ISSUE:
- Both CLI and iOS configure 8 HD slices (C-J) for hd1k_combo - this is correct
- CLI: 1859 disk buffer bytes free, boots successfully
- iOS: 170 disk buffer bytes free, heap exhausted at drive H, PANIC
- Root cause: iOS heap is being consumed faster than CLI
- Added SYSALLOC logging to track heap allocations
- Need to investigate why iOS uses ~1700 more heap bytes than CLI

INFOCOM/ZORK CRASH:
- hd1k_infocom.img crashes in CLI too (not iOS-specific)
- User debugging in romwbw_emu project first (easier to debug CLI)
- Will return to test iOS after CLI works

SESSION: Dec 17, 2024
---------------------

COMPLETED THIS SESSION:
- Fixed disk count persistence bug: added closeAllDisks() to clear old disks before loading new config
  - Files changed: hbios_core.cc, hbios_core.h, RomWBWEmulator.mm, RomWBWEmulator.h, EmulatorViewModel.swift
- Fixed auto-download: disks marked "(download)" now download when Play is pressed
- Fixed silent error handling: added popup alerts for catalog/disk errors

KNOWN ISSUE - ZORK1 PANIC:
- Running ZORK1 on infocom disk causes PANIC: @833C[32BB:0003:85BA:FD3F:D7A5]
- Boot shows "Insufficient HBIOS Heap Memory" for drives H, I, J
- Heap: starts at 0x0200, ends at 0x8000 (32KB available)
- Heap appears to run out during drive configuration (hd1k has 8 slices = A-H)
- Investigation needed: why is heap exhausted? Are allocations too large?
- Debug: enable debugMode in app to see SYSALLOC log messages

PREVIOUS NOTES:
---------------
- App renamed from RomWBW to Z80CPM
- Version 1.1.0 released with R8/W8 host file transfer utilities
- GitHub disks.xml catalog available

REMAINING TASKS:
- Investigate HBIOS heap exhaustion causing ZORK1 panic
- Mac App Store screenshots if needed
